[SERVICE]
    # Flush
    # =====
    # set an interval of seconds before to flush records to a destination
    flush        1

    # Daemon
    # ======
    # instruct Fluent Bit to run in foreground or background mode.
    daemon       Off

    # Log_Level
    # =========
    # Set the verbosity level of the service, values can be:
    #
    # - error
    # - warning
    # - info
    # - debug
    # - trace
    #
    # by default 'info' is set, that means it includes 'error' and 'warning'.
    #log_level    info

    # Parsers File
    # ============
    # specify an optional 'Parsers' configuration file
    parsers_file parsers.conf

    # Plugins File
    # ============
    # specify an optional 'Plugins' configuration file to load external plugins.
    plugins_file plugins.conf

    # HTTP Server
    # ===========
    # Enable/Disable the built-in HTTP Server for metrics
    http_server  Off
    http_listen  0.0.0.0
    http_port    2020

    # Storage
    # =======
    # Fluent Bit can use memory and filesystem buffering based mechanisms
    #
    # - https://docs.fluentbit.io/manual/administration/buffering-and-storage
    #
    # storage metrics
    # ---------------
    # publish storage pipeline metrics in '/api/v1/storage'. The metrics are
    # exported only if the 'http_server' option is enabled.
    #
    storage.metrics on

    # storage.path
    # ------------
    # absolute file system path to store filesystem data buffers (chunks).
    #
    # storage.path /tmp/storage

    # storage.sync
    # ------------
    # configure the synchronization mode used to store the data into the
    # filesystem. It can take the values normal or full.
    #
    # storage.sync normal

    # storage.checksum
    # ----------------
    # enable the data integrity check when writing and reading data from the
    # filesystem. The storage layer uses the CRC32 algorithm.
    #
    # storage.checksum off

    # storage.backlog.mem_limit
    # -------------------------
    # if storage.path is set, Fluent Bit will look for data chunks that were
    # not delivered and are still in the storage layer, these are called
    # backlog data. This option configure a hint of maximum value of memory
    # to use when processing these records.
    #
    # storage.backlog.mem_limit 5M

#[INPUT]
#    Name         winlog
#    Channels     Setup,Windows PowerShell
#    Interval_Sec 1

#[OUTPUT]
#    name  stdout
#    match *

# Installation https://docs.fluentbit.io/manual/installation/windows
# https://docs.newrelic.com/docs/logs/forward-logs/fluent-bit-plugin-log-forwarding/
# https://github.com/newrelic/fluentbit-examples
# I copied with replace newer fluent-bit files from C:\Program Files\New Relic\fluent-bit to C:\Program Files\New Relic\newrelic-infra\newrelic-integrations\logging
# Create service
# sc create fluent-bit binpath= "\"C:\Program Files\New Relic\newrelic-infra\newrelic-integrations\logging\fluent-bit.exe\" -c \"C:\Program Files\New Relic\newrelic-infra\newrelic-integrations\logging\fluent-bit.conf\""
# sc.exe start fluent-bit && sc.exe query fluent-bit
# Test fluent output 
#fluent-bit.exe -i dummy -o stdout
# To request data manually
# curl -i -H 'Content-Type:application/json' -H 'X-License-Key:eu01xx36c60862e9b56f16851cac9d85FFFFNRAL' -d '{"message":"sent from curl","key2":"val2.2"}' https://log-api.eu.newrelic.com/log/v1
# echo [2022-09-03 07:10:10Z] [INF] [a7997777] [DRN] [N/A] 123112test logs>>F:\storage\logs\api_20220903.log && echo bla-bla line2>>F:\storage\logs\api_20220906.log
# Test regexp https://rubular.com/r/kVdxhub23AbVMj

[INPUT]
    Name tail
    Path F:\storage\logs\api*.log
    Path_Key filePath
    Key message
    Tag api-salesrun
    Multiline On
    Parser_Firstline api-salesrun
    refresh_interval 30
    DB C:\Program Files\New Relic\newrelic-infra\newrelic-integrations\logging\fb.db

[INPUT]
    Name tail
    Path F:\storage\logs\cli*.log
    Path_Key filePath
    Key message
    Tag cli-salesrun
    Multiline On
    Parser_Firstline cli-salesrun
    refresh_interval 30

[INPUT]
    Name tail
    Path F:\storage\logs\migrator*.log
    Path_Key filePath
    Key message
    Tag migrator-salesrun
    Multiline On
    Parser_Firstline migrator-salesrun
    refresh_interval 30

[FILTER]
    Name record_modifier
    Match *
    Record hostname ${HOSTNAME}
    #Record product Awesome_Tool

[FILTER]
    Name record_modifier
    Match api-salesrun
    Record name api-salesrun

[FILTER]
    Name record_modifier
    Match cli-salesrun
    Record name cli-salesrun

[FILTER]
    Name record_modifier
    Match migrator-salesrun
    Record name migrator-salesrun

# Lua scripts modifying fields
# https://github.com/fluent/fluent-bit/blob/master/scripts/test.lua
[FILTER]
    Name    lua
    Match   *
    script  validate_level.lua
    call    validate_level

[FILTER]
    Name    lua
    Match   api-salesrun
    script  modify_scope.lua
    call    modify_scope

[OUTPUT]
    Name newrelic
    Match *
    licenseKey NEW_RELIC_LICENSE_KEY
    endpoint https://log-api.eu.newrelic.com/log/v1

#[OUTPUT]
#    Name file
#    File fluentbit_output.log
#    Match *
#    Path F:\storage

#[OUTPUT]
#    name stdout
#    match *

#[FILTER]
#    Name parser
#    Match api_salesrun
#    Key_Name message
#    Parser api_salesrun
#    Reserve_Data On
#    Preserve_Key On

